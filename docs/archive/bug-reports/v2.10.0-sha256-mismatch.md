# Bug Report: v2.10.0 SHA-256 Checksum Mismatch

**Date:** November 14, 2025
**Severity:** Critical (blocks OTA updates)
**Status:** Fixed in v2.10.1
**Reporter:** User testing
**Fixed By:** Claude Code

## Summary

OTA update from v2.9.0 to v2.10.0 failed with SHA-256 checksum mismatch error. Device correctly rejected firmware due to integrity check failure.

## Problem Description

When attempting OTA update via MQTT, device reported:

```
E (1479798) ota_manager: ‚ùå SHA-256 CHECKSUM MISMATCH!
E (1479798) ota_manager:    Expected: 00789a10279342b22e3fda8253304165022aba21c2ce1f5095c33ba9749a0e3e
E (1479806) ota_manager:    Actual:   8b58a6327197814662bed4f3b8eefb1e17352872b3314272fd51fbb0bee39971
E (1479814) ota_manager: ‚ùå Firmware integrity check failed, aborting OTA update
```

## Root Cause Analysis

### The Bug

The `calculate_partition_sha256()` function in `components/ota_manager/ota_manager.c` was hashing the **entire OTA partition** (2.5MB = 0x280000 bytes) instead of just the **actual firmware** (1.3MB = 1,336,608 bytes).

### Why This Failed

ESP32-S3 uses dual OTA partitions (ota_0 and ota_1) for safe firmware updates. When a new firmware is flashed:

1. Firmware (1.3MB) is written to start of partition (2.5MB)
2. **Residual data from previous firmware remains** in unused partition space
3. SHA-256 calculation included this residual data
4. Result: Hash mismatch because:
   - `version.json` contains SHA-256 of just the `.bin` file (1.3MB)
   - Device calculated SHA-256 of full partition (2.5MB) including old data

### Technical Details

**Partition Layout:**
```
OTA Partition (2.5MB = 0x280000):
‚îú‚îÄ 0x000000 - 0x145DEF: New firmware v2.10.0 (1,336,608 bytes)
‚îî‚îÄ 0x145DF0 - 0x27FFFF: Old firmware v2.9.0 residual data (1,179,392 bytes)
```

**Buggy Code (v2.10.0):**
```c
static esp_err_t calculate_partition_sha256(const esp_partition_t *partition, char *sha256_hex)
{
    size_t partition_size = partition->size;  // ‚ùå 2.5MB (includes residual)

    // ... SHA-256 calculation ...

    while (offset < partition_size) {  // ‚ùå Hashes 2.5MB
        // Reads and hashes partition data
    }
}
```

**Fixed Code (v2.10.1):**
```c
static esp_err_t calculate_partition_sha256(const esp_partition_t *partition,
                                           size_t firmware_size,  // ‚≠ê NEW parameter
                                           char *sha256_hex)
{
    size_t bytes_to_hash = (firmware_size > 0) ? firmware_size : partition->size;

    ESP_LOGI(TAG, "Calculating SHA-256 checksum of %lu bytes (partition size: %lu bytes)...",
             (unsigned long)bytes_to_hash, (unsigned long)partition->size);

    while (offset < bytes_to_hash) {  // ‚úÖ Only hashes actual firmware
        // Reads and hashes only firmware_size bytes
    }
}
```

**Caller Update:**
```c
// Get firmware size from OTA context (set by esp_https_ota)
uint32_t firmware_size = ota_context.total_bytes;

if (firmware_size == 0) {
    ESP_LOGE(TAG, "‚ùå Firmware size is 0, cannot verify");
    // Error handling
}

ESP_LOGI(TAG, "Firmware size: %lu bytes", firmware_size);

// Pass firmware_size to hash function
ret = calculate_partition_sha256(update_partition, firmware_size, actual_sha256);
```

## Impact

**Severity:** Critical - Completely blocked OTA updates

**Affected Versions:**
- v2.9.0: Initial version with SHA-256 verification (had bug)
- v2.10.0: Test release (exposed bug during testing)

**User Impact:**
- OTA updates fail with checksum mismatch
- Users must USB flash to get fixed version
- No security risk (system correctly rejects corrupted firmware)

## Fix Implementation

### Code Changes

**File:** `components/ota_manager/ota_manager.c`

**Change 1: Function Signature**
```diff
-static esp_err_t calculate_partition_sha256(const esp_partition_t *partition, char *sha256_hex)
+static esp_err_t calculate_partition_sha256(const esp_partition_t *partition, size_t firmware_size, char *sha256_hex)
```

**Change 2: Hash Calculation Logic**
```diff
-size_t partition_size = partition->size;
+size_t bytes_to_hash = (firmware_size > 0) ? firmware_size : partition->size;
+
+ESP_LOGI(TAG, "Calculating SHA-256 checksum of %lu bytes (partition size: %lu bytes)...",
+         (unsigned long)bytes_to_hash, (unsigned long)partition->size);

-while (offset < partition_size) {
+while (offset < bytes_to_hash) {
```

**Change 3: Get Firmware Size from OTA Context**
```diff
+// Get firmware size from OTA context
+uint32_t firmware_size = 0;
+if (xSemaphoreTake(ota_context.mutex, pdMS_TO_TICKS(1000)) == pdTRUE) {
+    firmware_size = ota_context.total_bytes;
+    xSemaphoreGive(ota_context.mutex);
+}
+
+if (firmware_size == 0) {
+    ESP_LOGE(TAG, "‚ùå Firmware size is 0, cannot verify");
+    esp_https_ota_abort(https_ota_handle);
+    update_state(OTA_STATE_FAILED, OTA_ERROR_CHECKSUM_MISMATCH);
+    vTaskDelete(NULL);
+    return;
+}

-ret = calculate_partition_sha256(update_partition, actual_sha256);
+ret = calculate_partition_sha256(update_partition, firmware_size, actual_sha256);
```

**Change 4: Format Specifier Fixes**
```diff
-ESP_LOGI(TAG, "Calculating SHA-256 checksum of %zu bytes...", partition_size);
+ESP_LOGI(TAG, "Calculating SHA-256 checksum of %lu bytes (partition size: %lu bytes)...",
+         (unsigned long)bytes_to_hash, (unsigned long)partition->size);
```

### Testing

**Test 1: Local SHA-256 Verification**
```bash
$ ./scripts/test_ota_locally.sh
================================================
OTA SHA-256 Verification Test
================================================
üì¶ Firmware size: 1336816 bytes
üîê Calculated SHA-256: c5f8086e23691ddc6c09ab7ff4dcfcd30e8d9155007d09f7281938d48e642eb1
üì± Device-simulated SHA-256: c5f8086e23691ddc6c09ab7ff4dcfcd30e8d9155007d09f7281938d48e642eb1
‚úÖ SHA-256 MATCH - OTA verification will succeed
```

**Test 2: Actual OTA Update v2.10.1 ‚Üí v2.10.2**
```
I (xxx) ota_manager: Firmware size: 1336816 bytes
I (xxx) ota_manager: Calculating SHA-256 checksum of 1336816 bytes (partition size: 2621440 bytes)...
I (xxx) ota_manager: SHA-256 checksum calculated: c5f8086e23691ddc6c09ab7ff4dcfcd30e8d9155007d09f7281938d48e642eb1
I (xxx) ota_manager: Expected SHA-256: c5f8086e23691ddc6c09ab7ff4dcfcd30e8d9155007d09f7281938d48e642eb1
I (xxx) ota_manager: ‚úÖ SHA-256 checksum verified successfully
```

## Migration Path

**Problem:** Devices running v2.9.0 or v2.10.0 cannot OTA update to v2.10.1+

**Why:** Old firmware has buggy SHA-256 calculation, will reject correctly-calculated checksum

**Solution:**
1. USB flash v2.10.1 to device
2. All future OTA updates work correctly via MQTT

**Commands:**
```bash
# One-time USB flash
idf.py build flash monitor

# Verify v2.10.1 running
# Boot log should show: "üöÄ Firmware v2.10.1 - SHA-256 Verification Fixed"

# Test OTA update to v2.10.2
mosquitto_pub -t home/Clock_Stani_1/command -m "ota_start_update"
```

## Lessons Learned

1. **Test OTA locally before deployment** - The bug would have been caught by `make ota-test`
2. **Understand partition behavior** - OTA partitions retain old data
3. **Use firmware size, not partition size** - Critical for dual-partition OTA
4. **Add unit tests** - Prevent regression of this bug
5. **Document migration paths** - Users need USB flash for buggy versions

## Prevention Measures

### 1. Automated Local Testing
Created `scripts/test_ota_locally.sh` to simulate device SHA-256 calculation before deployment.

### 2. Build System Integration
Updated `Makefile`:
```makefile
ota-release: build ota-test
    ./post_build_ota.sh --auto-push
```
Now `make ota-release` automatically runs SHA-256 test before deployment.

### 3. Unit Tests
Added `components/ota_manager/test/test_sha256_calculation.c` with regression test for this specific bug.

### 4. Documentation
- [OTA Testing Guide](../../developer/ota-testing-guide.md)
- This bug report

## Timeline

**Nov 14, 2025 10:00** - User requested v2.10.0 test release
**Nov 14, 2025 10:30** - Built and deployed v2.10.0 to GitHub
**Nov 14, 2025 11:00** - User attempted OTA update, reported SHA-256 mismatch
**Nov 14, 2025 11:15** - Root cause identified (partition size vs firmware size)
**Nov 14, 2025 11:30** - Fix implemented in v2.10.1
**Nov 14, 2025 12:00** - User USB flashed v2.10.1, confirmed fix
**Nov 14, 2025 12:30** - v2.10.2 released, OTA update successful
**Nov 14, 2025 13:00** - Prevention measures implemented

## Related Issues

- None (first occurrence of this bug type)

## References

- [components/ota_manager/ota_manager.c:105-749](../../components/ota_manager/ota_manager.c)
- [OTA Testing Guide](../../developer/ota-testing-guide.md)
- [Dual OTA Source System](../../technical/dual-ota-source-system.md)
- Git commits:
  - v2.10.0: `18b0b75`
  - v2.10.1: `52bf7f0`
  - v2.10.2: `af79ee3`

---

**Status:** ‚úÖ Fixed in v2.10.1
**Prevention:** ‚úÖ Automated testing implemented
**Documentation:** ‚úÖ Complete
